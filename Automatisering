alias: Zendure zenSDK (Gielz)
description: Versie 20260124-2
triggers:
  - seconds: /4
    id: aansturing_trigger
    trigger: time_pattern
  - at: "00:00:00"
    id: dynamisch_middernacht
    trigger: time
  - entity_id:
      - input_select.zendure_2400_ac_modus_selecteren
    id: modus_trigger
    trigger: state
  - trigger: state
    entity_id:
      - sensor.dynamisch_goedkoopste_periode
    id: modus_dynamisch_goedkoop
    for:
      hours: 0
      minutes: 0
      seconds: 15
    from:
      - Ja
    to:
      - Nee
  - trigger: state
    entity_id:
      - sensor.dynamisch_duurste_periode
    id: modus_dynamisch_duur
    for:
      hours: 0
      minutes: 0
      seconds: 15
    from:
      - Ja
    to:
      - Nee
  - trigger: state
    entity_id:
      - input_number.dynamisch_minimale_spread
    id: modus_dynamisch_spread
  - trigger: state
    entity_id:
      - input_number.zendure_2400_ac_max_oplaadvermogen
    id: systeem_instelling_maxoplaadvermogen
  - trigger: state
    entity_id:
      - input_number.zendure_2400_ac_max_ontlaadvermogen
    id: systeem_instelling_maxontlaadvermogen
conditions: []
actions:
  - alias: Modus Selecteren
    choose:
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Standby
        sequence:
          - action: rest_command.zendure_standby
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - action: logbook.log
            data:
              message: ‚ö†Ô∏è Opslagmodus omzetten naar Flash ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Standby
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Handmatig
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
        alias: Handmatig
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Nul op de meter
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
        alias: Nul op de meter
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Dynamisch NOM
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
        alias: Dynamisch NOM
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state:
              - Dynamisch NOM (Duur)
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
        alias: Dynamisch NOM (Duur)
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state:
              - Dynamisch Handelen
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
        alias: Dynamisch Handelen
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Alleen slim opladen
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
        alias: Alleen slim opladen
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Alleen slim ontladen
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
        alias: Alleen slim ontladen
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state:
              - Snel ontladen
        sequence:
          - action: rest_command.zendure_snel_ontladen
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              outputLimit: >-
                {{ states('input_number.zendure_2400_ac_max_ontlaadvermogen') |
                int }}
        alias: Snel ontladen
      - conditions:
          - condition: trigger
            id: modus_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state:
              - Snel opladen
        sequence:
          - action: rest_command.zendure_snel_laden
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              inputLimit: >-
                {{ states('input_number.zendure_2400_ac_max_oplaadvermogen') |
                int }}
        alias: Snel opladen
  - alias: Systeem
    choose:
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: state
            entity_id: sensor.zendure_2400_ac_opslagmodus
            state:
              - Opslaan in Flash
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: sensor.zendure_2400_ac_vermogen_aansturing
                above: 100
              - condition: numeric_state
                entity_id: sensor.zendure_2400_ac_vermogen_aansturing
                below: 0
          - condition: not
            conditions:
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Standby
        sequence:
          - action: rest_command.zendure_opslaan_in_ram
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - action: logbook.log
            data:
              message: |
                ‚ö†Ô∏è Opslagmodus omzetten naar RAM ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Wanneer opslag modus op Flash staat deze op RAM instellen
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: state
            entity_id: sensor.zendure_2400_ac_opslagmodus
            state:
              - Opslaan in RAM
          - condition: state
            entity_id: sensor.zendure_2400_ac_modus
            state:
              - Standby
            for:
              minutes: >-
                {{ states('input_number.zendure_2400_ac_standby_vertraging') |
                int(5) }}
        sequence:
          - action: rest_command.zendure_standby
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - action: logbook.log
            data:
              message: >-
                üí§ Na {{
                states('input_number.zendure_2400_ac_standby_vertraging') |
                int(5) }}                 minuten inactiviteit in standby
                zetten                 (Opslagmodus omzetten naar Flash) ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Na xx minuten inactiviteit in standby zetten
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: or
            conditions:
              - condition: template
                value_template: |
                  {{ (states('sensor.zendure_2400_ac_laadpercentage') | float) <
                     states('sensor.zendure_2400_ac_minimale_laadpercentage') | float }}
              - condition: template
                value_template: >
                  {{ (states('sensor.zendure_2400_ac_laadpercentage') | float |
                  round(0) ==
                      states('sensor.zendure_2400_ac_minimale_laadpercentage') | float | round(0))
                     and
                     (states('sensor.zendure_2400_ac_ingesteld_oplaadvermogen') | float == 1200) }}
            alias: SOC komt niet overeen met minimaal ingestelde SOC
          - condition: or
            conditions:
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Standby
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Nul op de meter
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Alleen slim opladen
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Alleen slim ontladen
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Dynamisch NOM
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Dynamisch NOM (Duur)
          - condition: or
            conditions:
              - condition: sun
                after: sunrise
                after_offset: "02:00:00"
                before: sunset
                before_offset: "-02:00:00"
              - alias: >-
                  sensor.p1_aansturing_vermogen kleiner dan
                  input_number.zendure_2400_ac_start_opladen_bij
                condition: template
                value_template: |
                  {{ states('sensor.p1_aansturing_vermogen') | float(0)
                     < states('input_number.zendure_2400_ac_opladen_starten_bij') | float(0) }}
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              inputLimit: >
                {% set soc = states('sensor.zendure_2400_ac_laadpercentage') |
                float | round(0) %} {% set min_soc =
                states('sensor.zendure_2400_ac_minimale_laadpercentage') | float
                | round(0) %} {{ 1200 if soc < min_soc else 0 }}
            action: rest_command.zendure_x_laden
          - action: logbook.log
            data:
              message: >
                ‚ö†Ô∏è Batterij SOC bescherming actief ‚Äî Vermogen ingesteld op   {%
                set soc = states('sensor.zendure_2400_ac_laadpercentage') |
                float |
                  round(0) %} {% set min_soc =
                  states('sensor.zendure_2400_ac_minimale_laadpercentage') | float | round(0) %}
                  {{ 1200 if soc < min_soc else 0 }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Opladen naar minimale SOC (bescherming)
      - conditions:
          - condition: trigger
            id:
              - systeem_instelling_maxoplaadvermogen
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              instellingitem: chargeMaxLimit
              instellinginhoud: >-
                {{ states('input_number.zendure_2400_ac_max_oplaadvermogen') |
                int }}
            action: rest_command.zendure_instelling
          - action: logbook.log
            data:
              message: >
                ‚öôÔ∏è Maximaal oplaadvermogen aangepast naar {{
                states('input_number.zendure_2400_ac_max_oplaadvermogen') | int
                }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Maximaal oplaadvermogen aanpassen
      - conditions:
          - condition: trigger
            id:
              - systeem_instelling_maxontlaadvermogen
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              instellingitem: inverseMaxPower
              instellinginhoud: >-
                {{ states('input_number.zendure_2400_ac_max_ontlaadvermogen') |
                int }}
            action: rest_command.zendure_instelling
          - action: logbook.log
            data:
              message: >
                ‚öôÔ∏è Maximaal ontlaadvermogen aangepast naar {{
                states('input_number.zendure_2400_ac_max_ontlaadvermogen') | int
                }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Maximaal ontlaadvermogen aanpassen
  - alias: NOM Aansturing
    choose:
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - alias: >-
              sensor.p1_aansturing_vermogen groter dan
              input_number.zendure_2400_ac_start_ontladen_bij
            condition: template
            value_template: |
              {{ states('sensor.p1_aansturing_vermogen') | float(0)
                 > states('input_number.zendure_2400_ac_ontladen_starten_bij') | float(0) }}
          - condition: state
            entity_id: sensor.zendure_2400_ac_soc_limiet_status
            state:
              - Normale werking
              - Laadlimiet bereikt
          - alias: Tot de minimaal ingestelde SOC
            condition: template
            value_template: |
              {{ states('sensor.zendure_2400_ac_laadpercentage') | float >
               states('sensor.zendure_2400_ac_minimale_laadpercentage') | float }}
          - condition: numeric_state
            entity_id: sensor.zendure_2400_ac_vermogen_aansturing
            above: -30
            below: 75
          - alias: Minstens 2 automatiseringen na opladen pas activeren
            condition: or
            conditions:
              - condition: state
                entity_id: sensor.zendure_2400_ac_modus
                state: Opladen
                for:
                  hours: 0
                  minutes: 0
                  seconds: 9
              - condition: state
                entity_id: sensor.zendure_2400_ac_modus
                state: Ontladen
              - condition: state
                entity_id: sensor.zendure_2400_ac_modus
                state: Standby
          - condition: or
            conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state: Nul op de meter
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state: Alleen slim ontladen
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state:
                      - Dynamisch NOM
              - condition: and
                conditions:
                  - condition: state
                    entity_id: sensor.dynamisch_duurste_periode
                    state:
                      - Ja
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state:
                      - Dynamisch NOM (Duur)
                  - alias: >-
                      sensor.dynamisch_spread_indicatie moet hoger of gelijk
                      zijn aan input_number.dynamisch_minimale_spread
                    condition: template
                    value_template: >-
                      {{ states('sensor.dynamisch_spread_indicatie') | float >=
                      states('input_number.dynamisch_minimale_spread') | float
                      }}
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              outputLimit: >-
                {% set factor = 0.75 %}  {% set cap =
                states('input_number.zendure_2400_ac_max_ontlaadvermogen') |
                float(0) %} {% set correctie = -1 *
                (states('input_number.zendure_2400_ac_ontlaadmarge') | float(0))
                %} {% set p1 = states('sensor.p1_aansturing_vermogen') |
                float(0) %}  {% set zendure =
                states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0)
                %}

                {% set totaal = (p1 - zendure - correctie) * factor %} {% set
                beperkt = [ [totaal, 0] | max, cap ] | min %}

                {{ beperkt | int }}
            action: rest_command.zendure_x_ontladen
          - action: logbook.log
            data:
              message: >
                üîã Ontladen starten ‚Äî Vermogen ingesteld op {% set factor = 0.75
                %} 
                  {% set cap = states('input_number.zendure_2400_ac_max_ontlaadvermogen') | float(0) %}
                  {% set correctie = -1 * (states('input_number.zendure_2400_ac_ontlaadmarge') | float(0)) %}
                  {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0) %} 
                  {% set zendure = states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0) %}

                  {% set totaal = (p1 - zendure - correctie) * factor %} {% set beperkt = [
                  [totaal, 0] | max, cap ] | min %} {{ beperkt | int }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Start met ontladen bij +xxx watt (75% van de vraag)
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: state
            entity_id: sensor.zendure_2400_ac_soc_limiet_status
            state:
              - Normale werking
              - Laadlimiet bereikt
          - alias: Tot de minimaal ingestelde SOC
            condition: template
            value_template: |
              {{ states('sensor.zendure_2400_ac_laadpercentage') | float >
               states('sensor.zendure_2400_ac_minimale_laadpercentage') | float }}
          - alias: >-
              Nieuw in te stellen vermogen is anders dan huidig batterij
              vermogen
            condition: template
            value_template: |-
              {% set factor = 1.00 %} {% set cap =
                states('input_number.zendure_2400_ac_max_ontlaadvermogen') | float(0) %} {% set correctie = -2 %} {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0) %} {% set zendure = states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0) %} {% set totaal = (p1 - zendure - correctie) * factor %} {% set beperkt = [ [totaal, 0] | max, cap ] | min %} {% set target = beperkt | int %} {% set huidig = states('sensor.zendure_2400_ac_ingesteld_ontlaadvermogen') | int(0) %} {{ huidig != target }}
          - condition: numeric_state
            entity_id: sensor.zendure_2400_ac_vermogen_aansturing
            below: 0
          - condition: or
            conditions:
              - condition: or
                conditions:
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state: Nul op de meter
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state: Alleen slim ontladen
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state:
                      - Dynamisch NOM
              - condition: and
                conditions:
                  - condition: state
                    entity_id: sensor.dynamisch_duurste_periode
                    state:
                      - Ja
                  - condition: state
                    entity_id: input_select.zendure_2400_ac_modus_selecteren
                    state:
                      - Dynamisch NOM (Duur)
                  - alias: >-
                      sensor.dynamisch_spread_indicatie moet hoger of gelijk
                      zijn aan input_number.dynamisch_minimale_spread
                    condition: template
                    value_template: >-
                      {{ states('sensor.dynamisch_spread_indicatie') | float >=
                      states('input_number.dynamisch_minimale_spread') | float
                      }}
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              outputLimit: >-
                {% set factor = 1.00 %}  {% set cap =
                states('input_number.zendure_2400_ac_max_ontlaadvermogen') |
                float(0) %} {% set correctie = -1 *
                (states('input_number.zendure_2400_ac_ontlaadmarge') | float(0))
                %} {% set p1 = states('sensor.p1_aansturing_vermogen') |
                float(0) %}  {% set zendure =
                states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0)
                %}

                {% set totaal = (p1 - zendure - correctie) * factor %} {% set
                beperkt = [ [totaal, 0] | max, cap ] | min %} {{ beperkt | int
                }}
            action: rest_command.zendure_x_ontladen_balanceren
          - action: logbook.log
            data:
              message: >
                ‚ö° Ontladen balanceren ‚Äî Vermogen ingesteld op {% set factor =
                1.00 %} 
                  {% set cap = states('input_number.zendure_2400_ac_max_ontlaadvermogen') | float(0) %}
                  {% set correctie = -1 * (states('input_number.zendure_2400_ac_ontlaadmarge') | float(0)) %}
                  {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0) %} 
                  {% set zendure = states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0) %}

                  {% set totaal = (p1 - zendure - correctie) * factor %} {% set beperkt = [
                  [totaal, 0] | max, cap ] | min %} {{ beperkt | int }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Tijdens ontladen balanceren naar -xxx watt (100% van de vraag)
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: state
            entity_id: sensor.zendure_2400_ac_soc_limiet_status
            state:
              - Normale werking
              - Ontlaadlimiet bereikt
          - condition: template
            value_template: >
              {{ states('sensor.zendure_2400_ac_laadpercentage') | float |
              round(0) >=
                 states('sensor.zendure_2400_ac_minimale_laadpercentage') | float | round(0) }}
            alias: SOC is gelijk of groter dan de minimale SOC
          - alias: >-
              sensor.p1_aansturing_vermogen kleiner dan
              input_number.zendure_2400_ac_start_opladen_bij
            condition: template
            value_template: |
              {{ states('sensor.p1_aansturing_vermogen') | float(0)
                 < states('input_number.zendure_2400_ac_opladen_starten_bij') | float(0) }}
          - alias: Lager dan maximaal ingestelde SOC
            condition: template
            value_template: |2-
                    {{ states('sensor.zendure_2400_ac_laadpercentage') | float(0) < 
                       states('sensor.zendure_2400_ac_maximale_laadpercentage') | float(0) }}
          - condition: numeric_state
            entity_id: sensor.zendure_2400_ac_vermogen_aansturing
            above: -30
            below: 30
          - condition: or
            conditions:
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Nul op de meter
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Alleen slim opladen
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Dynamisch NOM
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Dynamisch NOM (Duur)
          - alias: Minstens 2 automatiseringen na ontladen pas activeren
            condition: or
            conditions:
              - condition: state
                entity_id: sensor.zendure_2400_ac_modus
                state: Ontladen
                for:
                  hours: 0
                  minutes: 0
                  seconds: 9
                  milliseconds: 0
              - condition: state
                entity_id: sensor.zendure_2400_ac_modus
                state: Opladen
              - condition: state
                entity_id: sensor.zendure_2400_ac_modus
                state: Standby
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              inputLimit: >-
                {% set factor = 0.75 %} {% set cap =
                states('input_number.zendure_2400_ac_max_oplaadvermogen') |
                float(0) %} {% set correctie_export =
                states('input_number.zendure_2400_ac_oplaadmarge') | float(0) %}
                {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0)
                %} {% set zendure =
                states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0)
                %} {% set verschil = zendure - p1 - correctie_export %} {% set
                beperkt = verschil * factor if verschil > 0 else 0 %} {% set
                beperkt = beperkt if beperkt < cap else cap %} {{ beperkt | int
                }}
            action: rest_command.zendure_x_laden
          - action: logbook.log
            data:
              message: >
                üîã Opladen starten ‚Äî Vermogen ingesteld op {% set factor = 0.75
                %}
                  {% set cap = states('input_number.zendure_2400_ac_max_oplaadvermogen') | float(0) %}
                  {% set correctie_export = states('input_number.zendure_2400_ac_oplaadmarge') | float(0) %}
                  {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0) %}
                  {% set zendure = states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0) %}
                  {% set verschil = zendure - p1 - correctie_export %}
                  {% set beperkt = verschil * factor if verschil > 0 else 0 %}
                  {% set beperkt = beperkt if beperkt < cap else cap %}
                  {{ beperkt | int }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Start met opladen bij -xxx watt (75% van aanbod)
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: state
            entity_id: sensor.zendure_2400_ac_soc_limiet_status
            state:
              - Normale werking
              - Ontlaadlimiet bereikt
          - condition: template
            value_template: >
              {{ states('sensor.zendure_2400_ac_laadpercentage') | float |
              round(0) >=
                 states('sensor.zendure_2400_ac_minimale_laadpercentage') | float | round(0) }}
            alias: SOC is gelijk of groter dan de minimale SOC
          - alias: >-
              Nieuw in te stellen vermogen is anders dan huidig batterij
              vermogen
            condition: template
            value_template: |-
              {% set factor = 1.00 %} {% set cap =
                states('input_number.zendure_2400_ac_max_oplaadvermogen') | float(0) %} {% set correctie_export = 40 %} {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0) %} {% set zendure = states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0) %} {% set verschil = (zendure - p1 - correctie_export) * factor %} {% set beperkt = [ [verschil, 0] | max, cap ] | min %} {% set target = beperkt | int %} {% set huidig = states('sensor.zendure_2400_ac_ingesteld_oplaadvermogen') | int(0) %} {{ huidig != target }}
          - alias: Lager dan maximaal ingestelde SOC
            condition: template
            value_template: |2-
                    {{ states('sensor.zendure_2400_ac_laadpercentage') | float(0) < 
                       states('sensor.zendure_2400_ac_maximale_laadpercentage') | float(0) }}
          - condition: template
            value_template: "{{ this.attributes.current == 0 }}"
          - condition: numeric_state
            entity_id: sensor.zendure_2400_ac_vermogen_aansturing
            above: 0
          - condition: or
            conditions:
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Nul op de meter
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Alleen slim opladen
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state: Dynamisch NOM
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Dynamisch NOM (Duur)
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              inputLimit: >-
                {% set factor = 1.00 %}{% set cap =
                states('input_number.zendure_2400_ac_max_oplaadvermogen') |
                float(0) %} {% set correctie_export =
                states('input_number.zendure_2400_ac_oplaadmarge') | float(0) %}
                {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0)
                %} {% set zendure =
                states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0)
                %} {% set verschil = zendure - p1 - correctie_export %} {% set
                beperkt = verschil * factor if verschil > 0 else 0 %} {% set
                beperkt = beperkt if beperkt < cap else cap %} {{ beperkt | int
                }}
            action: rest_command.zendure_x_laden_balanceren
          - action: logbook.log
            data:
              message: >
                ‚ö° Opladen balanceren ‚Äî Vermogen ingesteld op {% set factor =
                1.00 %}
                  {% set cap = states('input_number.zendure_2400_ac_max_oplaadvermogen') | float(0) %}
                  {% set correctie_export = states('input_number.zendure_2400_ac_oplaadmarge') | float(0) %}
                  {% set p1 = states('sensor.p1_aansturing_vermogen') | float(0) %}
                  {% set zendure = states('sensor.zendure_2400_ac_vermogen_aansturing') | float(0) %}
                  {% set verschil = zendure - p1 - correctie_export %}
                  {% set beperkt = verschil * factor if verschil > 0 else 0 %}
                  {% set beperkt = beperkt if beperkt < cap else cap %}
                  {{ beperkt | int }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Tijdens opladen balanceren naar -xxx watt (100% van aanbod)
  - alias: Handmatige Aansturing
    choose:
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: or
            conditions:
              - condition: trigger
                id:
                  - aansturing_trigger
              - condition: trigger
                id:
                  - handmatig_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Handmatig
          - condition: numeric_state
            entity_id: input_number.zendure_2400_ac_handmatig_vermogen
            above: -1
          - condition: template
            value_template: >-
              {{ states('input_number.zendure_2400_ac_handmatig_vermogen') | int
              | abs !=
                 states('sensor.zendure_2400_ac_ingesteld_oplaadvermogen') | int }}
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              inputLimit: >-
                {{ states('input_number.zendure_2400_ac_handmatig_vermogen') |
                int | abs }}
            action: rest_command.zendure_x_laden
          - action: logbook.log
            data:
              message: >
                ‚ö° Handmatig laden ‚Äî Vermogen ingesteld op {{
                states('input_number.zendure_2400_ac_handmatig_vermogen') | int
                | abs }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Handmatig laden
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: or
            conditions:
              - condition: trigger
                id:
                  - aansturing_trigger
              - condition: trigger
                id:
                  - handmatig_trigger
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Handmatig
          - condition: numeric_state
            entity_id: input_number.zendure_2400_ac_handmatig_vermogen
            below: 1
          - condition: template
            value_template: >-
              {{ states('input_number.zendure_2400_ac_handmatig_vermogen') | int
              | abs !=
                 states('sensor.zendure_2400_ac_ingesteld_ontlaadvermogen') | int }}
        sequence:
          - data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              outputLimit: >-
                {{ states('input_number.zendure_2400_ac_handmatig_vermogen') |
                int | abs }}
            action: rest_command.zendure_x_ontladen
          - action: logbook.log
            data:
              message: >
                ‚ö° Handmatig ontladen ‚Äî Vermogen ingesteld op {{
                states('input_number.zendure_2400_ac_handmatig_vermogen') | int
                | abs }} watt ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Handmatig ontladen
  - alias: Dynamisch Aansturing (Nordpool HACS sensor vereist)
    choose:
      - conditions:
          - condition: trigger
            id:
              - dynamisch_middernacht
          - condition: template
            value_template: >-
              {{
              states('input_text.dynamisch_nordpool_sensor').lower().startswith('sensor')
              }}
            alias: input_text.dynamisch_nordpool_sensor is gevuld
        sequence:
          - alias: Zet goedkoopste periode van morgen naar vandaag
            target:
              entity_id: input_number.dynamisch_goedkoopste_x_periode
            data:
              value: >-
                {{ states('input_number.dynamisch_goedkoopste_x_periode_morgen')
                | float }}
            action: input_number.set_value
          - alias: Zet duurste periode van morgen naar vandaag
            target:
              entity_id: input_number.dynamisch_duurste_x_periode
            data:
              value: >-
                {{ states('input_number.dynamisch_duurste_x_periode_morgen') |
                float }}
            action: input_number.set_value
          - alias: Zet handmatige periode van morgen naar vandaag
            target:
              entity_id: input_text.dynamisch_handmatige_periode
            data:
              value: "{{ states('input_text.dynamisch_handmatige_periode_morgen') }}"
            action: input_text.set_value
          - alias: Reset handmatige periode van morgen
            target:
              entity_id: input_text.dynamisch_handmatige_periode_morgen
            data:
              value: ""
            action: input_text.set_value
          - action: logbook.log
            data:
              message: ‚öôÔ∏è Dynamische instelling overzetten van morgen naar vandaag ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Dynamisch omzetten van morgen naar vandaag
      - conditions:
          - condition: trigger
            id:
              - modus_dynamisch_goedkoop
              - modus_dynamisch_duur
              - modus_dynamisch_spread
          - condition: template
            value_template: >-
              {{
              states('input_text.dynamisch_nordpool_sensor').lower().startswith('sensor')
              }}
            alias: input_text.dynamisch_nordpool_sensor is gevuld
          - condition: or
            conditions:
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Dynamisch NOM (Duur)
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Dynamisch Handelen
          - condition: or
            conditions:
              - condition: numeric_state
                entity_id: sensor.zendure_2400_ac_vermogen_aansturing
                above: 0
              - condition: numeric_state
                entity_id: sensor.zendure_2400_ac_vermogen_aansturing
                below: 0
        sequence:
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - action: logbook.log
            data:
              message: >-
                üí≤ Dynamische dure/goedkope periode afgerond terug naar standby 
                ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Dynamische dure/goedkope periode afgerond terug naar standby
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: template
            value_template: >-
              {{
              states('input_text.dynamisch_nordpool_sensor').lower().startswith('sensor')
              }}
            alias: input_text.dynamisch_nordpool_sensor is gevuld
          - condition: state
            entity_id: sensor.dynamisch_goedkoopste_periode
            state: Ja
          - condition: state
            entity_id: input_boolean.dynamisch_recent_geladen
            state: "on"
            for:
              hours: 0
              minutes: 0
              seconds: 0
          - alias: SOC 10% lager dan maximale ingestelde SOC
            condition: template
            value_template: |
              {{ states('sensor.zendure_2400_ac_laadpercentage') | float(0) <= 
                 (states('sensor.zendure_2400_ac_maximale_laadpercentage') | float(0) - 10) }}
        sequence:
          - action: input_boolean.turn_off
            metadata: {}
            data: {}
            target:
              entity_id: input_boolean.dynamisch_recent_geladen
        alias: Dynamisch recent geladen uitzetten onder de 90% SOC
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: template
            value_template: >-
              {{
              states('input_text.dynamisch_nordpool_sensor').lower().startswith('sensor')
              }}
            alias: input_text.dynamisch_nordpool_sensor is gevuld
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state: Dynamisch NOM
          - condition: state
            entity_id: sensor.dynamisch_goedkoopste_periode
            state: Ja
          - condition: state
            entity_id: input_boolean.dynamisch_recent_geladen
            state: "off"
          - condition: state
            entity_id: sensor.zendure_2400_ac_soc_limiet_status
            state:
              - Normale werking
              - Ontlaadlimiet bereikt
          - alias: SOC lager dan maximaal ingestelde SOC
            condition: template
            value_template: |2-
                    {{ states('sensor.zendure_2400_ac_laadpercentage') | float(0) < 
                       states('sensor.zendure_2400_ac_maximale_laadpercentage') | float(0) }}
          - alias: >-
              sensor.dynamisch_spread_indicatie_nom moet hoger of gelijk zijn
              aan input_number.dynamisch_minimale_spread
            condition: template
            value_template: >-
              {{ states('sensor.dynamisch_spread_indicatie_nom') | float >=
              states('input_number.dynamisch_minimale_spread') | float }}
        sequence:
          - action: rest_command.zendure_opslaan_in_ram
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - delay:
              hours: 0
              minutes: 0
              seconds: 5
              milliseconds: 0
          - action: rest_command.zendure_snel_laden
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              inputLimit: >-
                {{ states('input_number.zendure_2400_ac_max_oplaadvermogen') |
                int }}
          - action: logbook.log
            data:
              message: üí≤ Dynamisch NOM goedkoop laden gestart ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
          - wait_for_trigger:
              - entity_id: sensor.dynamisch_goedkoopste_periode
                to: Nee
                trigger: state
              - trigger: template
                value_template: >
                  {{ states('sensor.zendure_2400_ac_laadpercentage') | float(0)
                  ==
                     states('sensor.zendure_2400_ac_maximale_laadpercentage') | float(0) }}
                alias: Maximale ingestelde SOC bereikt
              - trigger: state
                entity_id:
                  - input_select.zendure_2400_ac_modus_selecteren
              - trigger: state
                entity_id:
                  - input_number.dynamisch_minimale_spread
              - trigger: state
                entity_id:
                  - sensor.dynamisch_spread_indicatie_nom
            continue_on_timeout: false
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - entity_id: input_boolean.dynamisch_recent_geladen
            action: input_boolean.turn_on
            alias: input_boolean.dynamisch_recent_geladen aanzetten
          - action: logbook.log
            data:
              message: üí≤ Dynamisch NOM goedkoop laden voltooid  ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Dynamisch NOM goedkoop laden
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: template
            value_template: >-
              {{
              states('input_text.dynamisch_nordpool_sensor').lower().startswith('sensor')
              }}
            alias: input_text.dynamisch_nordpool_sensor is gevuld
          - condition: or
            conditions:
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Dynamisch NOM (Duur)
              - condition: state
                entity_id: input_select.zendure_2400_ac_modus_selecteren
                state:
                  - Dynamisch Handelen
          - condition: state
            entity_id: sensor.dynamisch_goedkoopste_periode
            state: Ja
          - condition: state
            entity_id: input_boolean.dynamisch_recent_geladen
            state: "off"
          - condition: state
            entity_id: sensor.zendure_2400_ac_soc_limiet_status
            state:
              - Normale werking
              - Ontlaadlimiet bereikt
          - alias: SOC lager dan maximaal ingestelde SOC
            condition: template
            value_template: |2-
                    {{ states('sensor.zendure_2400_ac_laadpercentage') | float(0) < 
                       states('sensor.zendure_2400_ac_maximale_laadpercentage') | float(0) }}
          - alias: >-
              sensor.dynamisch_spread_indicatie moet hoger of gelijk zijn aan
              input_number.dynamisch_minimale_spread
            condition: template
            value_template: >-
              {{ states('sensor.dynamisch_spread_indicatie') | float >=
              states('input_number.dynamisch_minimale_spread') | float }}
        sequence:
          - action: rest_command.zendure_opslaan_in_ram
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - delay:
              hours: 0
              minutes: 0
              seconds: 5
              milliseconds: 0
          - action: rest_command.zendure_snel_laden
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              inputLimit: >-
                {{ states('input_number.zendure_2400_ac_max_oplaadvermogen') |
                int }}
          - action: logbook.log
            data:
              message: üí≤ Dynamisch goedkoop laden gestart ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
          - wait_for_trigger:
              - entity_id: sensor.dynamisch_goedkoopste_periode
                to: Nee
                trigger: state
              - trigger: template
                value_template: >
                  {{ states('sensor.zendure_2400_ac_laadpercentage') | float(0)
                  ==
                     states('sensor.zendure_2400_ac_maximale_laadpercentage') | float(0) }}
                alias: Maximale ingestelde SOC bereikt
              - trigger: state
                entity_id:
                  - input_select.zendure_2400_ac_modus_selecteren
              - trigger: state
                entity_id:
                  - input_number.dynamisch_minimale_spread
              - trigger: state
                entity_id:
                  - sensor.dynamisch_spread_indicatie
            continue_on_timeout: false
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - entity_id: input_boolean.dynamisch_recent_geladen
            action: input_boolean.turn_on
            alias: input_boolean.dynamisch_recent_geladen aanzetten
          - action: logbook.log
            data:
              message: üí≤ Dynamisch goedkoop laden voltooid  ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Dynamisch goedkoop laden
      - conditions:
          - condition: trigger
            id:
              - aansturing_trigger
          - condition: template
            value_template: >-
              {{
              states('input_text.dynamisch_nordpool_sensor').lower().startswith('sensor')
              }}
            alias: input_text.dynamisch_nordpool_sensor is gevuld
          - condition: state
            entity_id: input_select.zendure_2400_ac_modus_selecteren
            state:
              - Dynamisch Handelen
          - condition: state
            entity_id: sensor.zendure_2400_ac_soc_limiet_status
            state:
              - Normale werking
              - Laadlimiet bereikt
          - alias: Tot de minimaal ingestelde SOC
            condition: template
            value_template: |
              {{ states('sensor.zendure_2400_ac_laadpercentage') | float >
               states('sensor.zendure_2400_ac_minimale_laadpercentage') | float }}
          - condition: state
            entity_id: sensor.dynamisch_duurste_periode
            state:
              - Ja
          - alias: >-
              sensor.dynamisch_spread_indicatie moet hoger of gelijk zijn aan
              input_number.dynamisch_minimale_spread
            condition: template
            value_template: >-
              {{ states('sensor.dynamisch_spread_indicatie') | float >=
              states('input_number.dynamisch_minimale_spread') | float }}
        sequence:
          - action: rest_command.zendure_opslaan_in_ram
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - delay:
              hours: 0
              minutes: 0
              seconds: 5
              milliseconds: 0
          - action: rest_command.zendure_snel_ontladen
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
              outputLimit: >-
                {{ states('input_number.zendure_2400_ac_max_ontlaadvermogen') |
                int }}
          - action: logbook.log
            data:
              message: üí≤ Dynamisch duur ontladen gestart ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
          - wait_for_trigger:
              - alias: Tot minimale SOC
                trigger: template
                value_template: |-
                  {{ states('sensor.zendure_2400_ac_laadpercentage') | float <=
                     states('sensor.zendure_2400_ac_minimale_laadpercentage') | float }}
              - entity_id:
                  - sensor.dynamisch_duurste_periode
                to:
                  - Nee
                trigger: state
              - trigger: state
                entity_id:
                  - input_select.zendure_2400_ac_modus_selecteren
            continue_on_timeout: false
          - action: rest_command.zendure_stop_met_alles
            data:
              sn: "{{ states('sensor.zendure_2400_ac_serienummer') }}"
          - action: logbook.log
            data:
              message: üí≤ Dynamisch duur ontladen voltooid  ‚Äî
              entity_id: input_select.zendure_2400_ac_modus_selecteren
              name: " "
        alias: Dynamisch duur ontladen
mode: queued
max: 8
